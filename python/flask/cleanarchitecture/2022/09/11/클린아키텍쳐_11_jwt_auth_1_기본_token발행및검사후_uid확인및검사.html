<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>클린아키텍쳐 11 jwt auth token 발행과 검사 및 uid 검사 | 돌범텤놑</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="클린아키텍쳐 11 jwt auth token 발행과 검사 및 uid 검사" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="python clean architecture" />
<meta property="og:description" content="python clean architecture" />
<link rel="canonical" href="blog.chojaeseong.com/python/flask/cleanarchitecture/2022/09/11/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90_11_jwt_auth_1_%EA%B8%B0%EB%B3%B8_token%EB%B0%9C%ED%96%89%EB%B0%8F%EA%B2%80%EC%82%AC%ED%9B%84_uid%ED%99%95%EC%9D%B8%EB%B0%8F%EA%B2%80%EC%82%AC.html" />
<meta property="og:url" content="blog.chojaeseong.com/python/flask/cleanarchitecture/2022/09/11/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90_11_jwt_auth_1_%EA%B8%B0%EB%B3%B8_token%EB%B0%9C%ED%96%89%EB%B0%8F%EA%B2%80%EC%82%AC%ED%9B%84_uid%ED%99%95%EC%9D%B8%EB%B0%8F%EA%B2%80%EC%82%AC.html" />
<meta property="og:site_name" content="돌범텤놑" />
<meta property="og:image" content="blog.chojaeseong.com/images/posts/python.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-09-11T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2022-09-11T00:00:00-05:00","url":"blog.chojaeseong.com/python/flask/cleanarchitecture/2022/09/11/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90_11_jwt_auth_1_%EA%B8%B0%EB%B3%B8_token%EB%B0%9C%ED%96%89%EB%B0%8F%EA%B2%80%EC%82%AC%ED%9B%84_uid%ED%99%95%EC%9D%B8%EB%B0%8F%EA%B2%80%EC%82%AC.html","@type":"BlogPosting","image":"blog.chojaeseong.com/images/posts/python.png","headline":"클린아키텍쳐 11 jwt auth token 발행과 검사 및 uid 검사","dateModified":"2022-09-11T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"blog.chojaeseong.com/python/flask/cleanarchitecture/2022/09/11/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90_11_jwt_auth_1_%EA%B8%B0%EB%B3%B8_token%EB%B0%9C%ED%96%89%EB%B0%8F%EA%B2%80%EC%82%AC%ED%9B%84_uid%ED%99%95%EC%9D%B8%EB%B0%8F%EA%B2%80%EC%82%AC.html"},"description":"python clean architecture","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<!-- 폰트추가를 위한 link태그 삽입 -->
  <!-- 폰트1:  기본 spoqa 웹폰트 -->
  <!-- css에서 * {} 다 뒤집어씀. -->
  <link href='//spoqa.github.io/spoqa-han-sans/css/SpoqaHanSansNeo.css' rel='stylesheet' type='text/css'>
  <!-- 폰트2:  블로그 제목들 sunflower 웹폰트 -->
  <!-- 쥬피터 등 포스트 내부 글자 h1, h2 제목은 sunflower체 도입 -->
  <link href="//fonts.googleapis.com/css?family=Sunflower:300,500,700" rel="stylesheet"> 

  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="blog.chojaeseong.com/feed.xml" title="돌범텤놑" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">돌범텤놑</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">클린아키텍쳐 11 jwt auth token 발행과 검사 및 uid 검사</h1><p class="page-description">python clean architecture</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-09-11T00:00:00-05:00" itemprop="datePublished">
        Sep 11, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      11 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#flask">flask</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#cleanarchitecture">cleanarchitecture</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!-- toc가 먼저 나오므로 h3로 안내하기 -->
    <h3>📜 제목으로 보기</h3>
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#클린-아키텍쳐-11장">클린 아키텍쳐 11장</a>
<ul>
<li class="toc-entry toc-h2"><a href="#1-세팅">1 세팅</a>
<ul>
<li class="toc-entry toc-h3"><a href="#01-첫-프로젝트-구조--not-clean-architecture">01 첫 프로젝트 구조  (not clean architecture)</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-src-routepy">001 src&gt; route.py</a>
<ul>
<li class="toc-entry toc-h5"><a href="#flask-blueprint-jsonify로-secret-route-구성">flask Blueprint, jsonify로 /secret route 구성</a></li>
</ul>
</li>
<li class="toc-entry toc-h4"><a href="#002-src-serverpy">002 src&gt; server.py</a>
<ul>
<li class="toc-entry toc-h5"><a href="#작성된-route의-route등록객체--flask-flask--flask_cors-cors---app객체-생성후-초기화">작성된 .route의 route등록객체 + flask Flask + flask_cors CORS -&gt; app객체 생성후 초기화</a></li>
</ul>
</li>
<li class="toc-entry toc-h4"><a href="#003-root--runpy">003 root &gt; run.py</a>
<ul>
<li class="toc-entry toc-h5"><a href="#app객체-import-및-name-main시-실행코드">app객체 import 및 name main시 실행코드</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#02-clean-architecture">02 clean architecture</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-src-main-routes--api_routespy에-secret-get-route-추가">001 src&gt; main&gt; routes &gt; api_routes.py에 /secret [GET] route 추가</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#03-postman으로-secret-get-route-test">03 POSTMAN으로 /secret GET route TEST</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#2-flask-login-대신-pyjwt">2 Flask-login 대신 PyJWT</a>
<ul>
<li class="toc-entry toc-h3"><a href="#01-pyjwt-설치">01 PyJWT 설치</a></li>
<li class="toc-entry toc-h3"><a href="#02-jwt-datetime-datetimetimedelta-import-하고-auth-post-route-추가">02 jwt, datetime-datetime/timedelta import 하고 /auth [POST] route 추가</a></li>
<li class="toc-entry toc-h3"><a href="#03-auth-post-route에서-token-발급---jwtencodeexp-dattime--key-algorithm로-token-생성">03 /auth POST route에서 token 발급 -&gt; jwt.encode({‘exp’: dattime }, key=, algorithm=)로 token 생성</a>
<ul>
<li class="toc-entry toc-h4"><a href="#route내에서-jwt모듈은-exp만료기간을-포함한-dict를-key와-algorithm을-지정하여-encode-메서드로-token을-만든다">route내에서 jwt모듈은 ‘exp(만료기간)’을 포함한 dict를 key=와 algorithm=을 지정하여 .encode() 메서드로 token을 만든다.</a></li>
<li class="toc-entry toc-h4"><a href="#rs256과-hs256-둘다-sha-256암호화-알고리즘이지만-hs가-secret-key를-가지고-암호화해서-더-안전하다고-한다">RS256과 HS256 둘다 SHA-256암호화 알고리즘이지만, HS가 secret key를 가지고 암호화해서 더 안전하다고 한다</a></li>
<li class="toc-entry toc-h4"><a href="#환경변수-지정해서-flask-run---postman으로-확인하기">환경변수 지정해서, flask run -&gt; POSTMAN으로 확인하기</a></li>
<li class="toc-entry toc-h4"><a href="#생성된-token을-버리지-말고-가지고-있는다">생성된 token을 버리지 말고 가지고 있는다.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#3-기본token-발급-및-decode시-발생하는-예외-처리">3 기본token 발급 및 decode시 발생하는 예외 처리</a>
<ul>
<li class="toc-entry toc-h3"><a href="#01-token-decode-검사-in-headersgetauthorization-in-get-route">01 token decode 검사 in Headers.get(“Authorization”) in GET route</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-error-secret-get-route에서-requestheaders-속-authorization-key를-확인하고-token자체가-없으면-token문제가-아니라-400-bad-request다">001 [ERROR] /secret GET route에서 request.headers 속 “Authorization” key를 확인하고 token자체가 없으면 token문제가 아니라 400 Bad Request다</a></li>
<li class="toc-entry toc-h4"><a href="#002-postman에서는-get요청시-authorization-type을-bearer--token을-선택하고-jwtencode로-만든-토큰을-입력한다">002 POSTMAN에서는 GET요청시 Authorization TYPE을 Bearer  Token을 선택하고, jwt.encode로 만든 토큰을 입력한다.</a></li>
<li class="toc-entry toc-h4"><a href="#003-받은-token을-출력해본다">003 받은 token을 출력해본다.</a></li>
<li class="toc-entry toc-h4"><a href="#004-token은-사실-앞에-bearer--가-붙은-raw_token으로-간주하고-split해서-token만-취한-뒤--jwtdecodekey-algorhitm으로-암호화시-사용한-동일-key와-algo로-암호화해독한-token_information을-출력해본다">004 token은 사실 앞에 Bearer[ ] 가 붙은 raw_token으로 간주하고 split해서 token만 취한 뒤 , jwt.decode(,key=, algorhitm=)으로 암호화시 사용한 동일 key와 algo로 암호화해독한 token_information을 출력해본다.</a>
<ul>
<li class="toc-entry toc-h5"><a href="#나는-한참있다가-했더니-post-route에서-발급한-token-expire--jwtexceptionsexpiredsignatureeror가-난다">나는 한참있다가 했더니.. POST route에서 발급한 token expire =&gt; jwt.exceptions.ExpiredSignatureEror가 난다</a></li>
<li class="toc-entry toc-h5"><a href="#다시-auth-post-route에서-토큰을-발급생성하고-secret-get-route에서-토큰-검사를-해보자">다시 /auth POST route에서 토큰을 발급(생성)하고, /secret GET route에서 토큰 검사를 해보자.</a></li>
<li class="toc-entry toc-h5"><a href="#decode한-token은-encode할때의-dictexp포함가-그대로-출력된다">decode한 token은 encode할때의 dict(‘exp’포함)가 그대로 출력된다</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#02-invalid한-token막토큰-12개-지운-토큰해서-get요청해보기">02 invalid한 token(막토큰, 1~2개 지운 토큰)해서 GET요청해보기</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-error-막token은-검사시-jwtexceptionsdecodeerror가-난다---근데-막토큰을-올릴이-없다">001 [ERROR] 막token은 검사시 jwt.exceptions.DecodeError가 난다 -&gt; 근데 막토큰을 올릴이 없다?</a></li>
<li class="toc-entry toc-h4"><a href="#002-error-원래-토큰에서-12글자를-지우면-jwtexceptionsinvalidsignatureerror가-난다">002 [ERROR] 원래 토큰에서 1~2글자를 지우면, jwt.exceptions.InvalidSignatureError가 난다</a>
<ul>
<li class="toc-entry toc-h5"><a href="#error-막token말고-12글자빠진-tokeninvalid-token을-if-not-token과-동일한-498로-잡자">[ERROR] 막token말고 1~2글자빠진 token(Invalid token)을 if not token과 동일한 498로 잡자</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#03-token-발급-auth-post-route에서-발급encode시-exp를-1초로해서-expire관련-에러-잡기">03 token 발급 /auth POST route에서 발급(encode)시 exp를 1초로해서.. Expire관련 에러 잡기</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-post-발급route에서-encode시-exp의-값을-현재시간--timedeltaseconds1로-줘서-무조건-만료된-상태를-만단다">001 POST 발급route에서 encode시 ‘exp’의 값을 현재시간 + timedelta(seconds=1)로 줘서 무조건 만료된 상태를 만단다.</a></li>
<li class="toc-entry toc-h4"><a href="#002-error-get-확인-route에서-jwtexpiredsignatureerror를-토큰이-존재하지-않을-때와-동일한-401unauthorized로-잡는다">002 [ERROR] GET 확인 route에서 jwt.ExpiredSignatureError를 토큰이 존재하지 않을 때와 동일한 401(Unauthorized)로 잡는다.</a></li>
<li class="toc-entry toc-h4"><a href="#003-postman에서-post-1초짜리-발급----get-expiredtoken401을-확인한다">003 POSTMAN에서 POST 1초짜리 발급 -&gt;  GET ExpiredToken401을 확인한다.</a></li>
<li class="toc-entry toc-h4"><a href="#expiredtoken-에럴-잡았으면-다시-exp를-30분으로-돌려놓자">expiredtoken 에럴 잡았으면 다시 exp를 30분으로 돌려놓자</a></li>
<li class="toc-entry toc-h4"><a href="#참고--expired-token-이외에--498-invalid-token도-401으로-잡아도-된다">참고)  expired token 이외에 + 498 invalid token도 401으로 잡아도 된다.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#4-agent의-token외-user의-id-uid도-추가">4 Agent의 token외 user의 id (uid)도 추가</a>
<ul>
<li class="toc-entry toc-h3"><a href="#01-token발급-route에서-exp외에-발급요청자의-uid를-포함해서-발급">01 token발급 route에서 exp외에 [발급요청자의 uid]를 포함해서 발급</a></li>
<li class="toc-entry toc-h3"><a href="#02-token확인-route에서-headers에-authorization이외에-현재user의-token확인요청자의-uid도-꺼내서-token발급자의-uid와-비교">02 token확인 route에서, headers에 “Authorization”이외에 현재user의 [token확인요청자의 “uid”]도 꺼내서 [token발급자의 uid]와 비교</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-error-현재-요청사용자의-uid를-headers에서-꺼낸다-token이-없는것-외에-uid가-없어도-400에러다">001 [ERROR] 현재 요청사용자의 uid를 headers에서 꺼낸다. token이 없는것 외에 uid가 없어도 400에러다</a></li>
<li class="toc-entry toc-h4"><a href="#002-발급시-token에-포함된-uid를--decode된-token_information에서-꺼내-변수로-받아놓는다">002 발급시 token에 포함된 uid를  decode된 token_information에서 꺼내 변수로 받아놓는다.</a></li>
<li class="toc-entry toc-h4"><a href="#003-token-decode과정에서-발생하는-예외통과시-token_uid-vs-현재uid를-비교하여-다를시-400으로-예외를-처리한다형변환해서-확인">003 token decode과정에서 발생하는 예외통과시, token_uid vs 현재uid를 비교하여 다를시, 400으로 예외를 처리한다(형변환해서 확인)</a></li>
<li class="toc-entry toc-h4"><a href="#token관련-테스트는-항상-post로-새로-발급---복사---get으로-인증요청하자--엥-not-uid에-걸려-401-에러가-난다">token관련 테스트는 항상 POST로 새로 발급 -&gt; 복사 -&gt; GET으로 인증요청하자 =&gt; 엥? not uid에 걸려 401 에러가 난다</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#03-uid는-authorization과-달리-postman-get요청시-headers에-직접-줘야한다">03 uid는 Authorization과 달리, POSTMAN GET요청시, Headers에 직접 줘야한다</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-get요청시-headers를-따로-준-적이-없었는데-uid테스트가-처음이다">001 GET요청시 Headers를 따로 준 적이 없었는데 uid테스트가 처음이다</a></li>
<li class="toc-entry toc-h4"><a href="#002-확인해보니-headers-속--uid는-string으로-token속-발급시-지정해준-uid는-int타입이었다">002 확인해보니, headers 속  uid는 string으로, token속 발급시 지정해준 uid는 int타입이었다.</a></li>
<li class="toc-entry toc-h4"><a href="#003-발급시와-다른-uid를-headers에-박아서-token확인요청-한다면--token_uid-vs-uid-비교시-내는-user-not-permission이-나와야한다">003 발급시와 다른 uid를 headers에 박아서 token확인요청 한다면?  token_uid vs uid 비교시 내는 User not permission이 나와야한다</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#04-또다른-uid관련-에러-처리---token생성시-필수-dictk-key인-uid를--없이-생성한-경우">04 또다른 uid관련 에러 처리 -&gt; token생성시 필수 dictk-key인 uid를,  없이 생성한 경우</a>
<ul>
<li class="toc-entry toc-h4"><a href="#001-headers-속-uid는-get으로-꺼내고-없으면-400에러였다">001 headers 속 uid는 .get()으로 꺼내고 없으면 400에러였다</a></li>
<li class="toc-entry toc-h4"><a href="#002-그러나-token은--발급post시-무조건-uid를-넣은-상태로-encoding해야하며-확인요청get시-token_infouid로-강제로-key를-꺼낸다">002 그러나 token은  발급(POST)시 무조건 uid를 넣은 상태로 encoding해야하며, 확인요청(GET)시 token_info[“uid”]로 강제로 key를 꺼낸다.</a></li>
<li class="toc-entry toc-h4"><a href="#003-error-필수적으로-있어야할-dict-key-not-get인-uid가-token에-없으면-keyerror로-잡고-401-에러를-낸다-임의로-invalid-token2로-메세지를-잡는다">003 [ERROR] 필수적으로 있어야할 dict key( not .get())인 uid가 token에 없으면 KeyError로 잡고 401 에러를 낸다. 임의로 “Invalid Token2”로 메세지를 잡는다</a>
<ul>
<li class="toc-entry toc-h5"><a href="#uid없이-토큰발급-error를-내보기-위해--post-route에서-임시로-uid-key-value를-삭제하고-테스트">uid없이 토큰발급 Error를 내보기 위해,  POST route에서 임시로 uid key-value를 삭제하고 테스트</a></li>
<li class="toc-entry toc-h5"><a href="#다시-발급시-uid-넣어주자">다시 발급시 uid 넣어주자</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#참고">참고</a>
<ul>
<li class="toc-entry toc-h4"><a href="#gitignore">gitignore</a></li>
<li class="toc-entry toc-h4"><a href="#sqlalchemy패키지">sqlalchemy패키지</a></li>
<li class="toc-entry toc-h4"><a href="#github에서-br따서-작업하기">github에서 br따서 작업하기</a>
<ul>
<li class="toc-entry toc-h5"><a href="#1-1-github에서-br생성--clone">[1-1] github에서 br생성 ~ clone</a></li>
<li class="toc-entry toc-h5"><a href="#clone후-초기-작업-세팅">clone후 초기 작업 세팅</a></li>
<li class="toc-entry toc-h5"><a href="#1-2-작업끝난-br의-폴더에서-새-작업-br생성--분기게시-초기세팅-또-안해도-되는-장점">[1-2] 작업끝난 br의 폴더에서 새 작업 br생성 ~ 분기게시 (초기세팅 또 안해도 되는 장점)</a></li>
<li class="toc-entry toc-h5"><a href="#1-3--옛날에-따둔-br에서-작업시작할-땐-최신-master를-pull---rebase후에-작업시작하기">[1-3]  옛날에 따둔 br에서 작업시작할 땐, 최신 master를 pull -&gt; rebase후에 작업시작하기</a></li>
<li class="toc-entry toc-h5"><a href="#2-framework-있다면-venv에-환경변수-세팅---vscode-디버깅-세팅">[2] framework 있다면 venv에 환경변수 세팅 -&gt; vscode 디버깅 세팅</a></li>
<li class="toc-entry toc-h5"><a href="#3-해당br-작업테스트-완료후--merge까지-정리">[3] 해당br 작업(테스트) 완료후 ~ merge까지 정리</a></li>
</ul>
</li>
<li class="toc-entry toc-h4"><a href="#vscode-설정">vscode 설정</a></li>
<li class="toc-entry toc-h4"><a href="#test정리">test정리</a></li>
<li class="toc-entry toc-h4"><a href="#status_code">status_code</a></li>
<li class="toc-entry toc-h4"><a href="#powershell-환경변수-등록확인">powershell 환경변수 등록/확인</a></li>
</ul>
</li>
</ul>
</li>
</ul><h1 id="클린-아키텍쳐-11장">
<a class="anchor" href="#%ED%81%B4%EB%A6%B0-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90-11%EC%9E%A5" aria-hidden="true"><span class="octicon octicon-link"></span></a>클린 아키텍쳐 11장</h1>

<h2 id="1-세팅">
<a class="anchor" href="#1-%EC%84%B8%ED%8C%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>1 세팅</h2>

<h3 id="01-첫-프로젝트-구조--not-clean-architecture">
<a class="anchor" href="#01-%EC%B2%AB-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B5%AC%EC%A1%B0--not-clean-architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>01 첫 프로젝트 구조  (not clean architecture)</h3>

<h4 id="001-src-routepy">
<a class="anchor" href="#001-src-routepy" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 src&gt; route.py</h4>

<h5 id="flask-blueprint-jsonify로-secret-route-구성">
<a class="anchor" href="#flask-blueprint-jsonify%EB%A1%9C-secret-route-%EA%B5%AC%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>flask Blueprint, jsonify로 /secret route 구성</h5>

<ul>
  <li>clean architecture라면 <code class="language-plaintext highlighter-rouge">src&gt; main &gt; routes &gt; api_routes.py</code>
</li>
</ul>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009214051476.png" alt="image-20221009214051476"></p>

<p>###</p>

<h4 id="002-src-serverpy">
<a class="anchor" href="#002-src-serverpy" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 src&gt; server.py</h4>

<h5 id="작성된-route의-route등록객체--flask-flask--flask_cors-cors---app객체-생성후-초기화">
<a class="anchor" href="#%EC%9E%91%EC%84%B1%EB%90%9C-route%EC%9D%98-route%EB%93%B1%EB%A1%9D%EA%B0%9D%EC%B2%B4--flask-flask--flask_cors-cors---app%EA%B0%9D%EC%B2%B4-%EC%83%9D%EC%84%B1%ED%9B%84-%EC%B4%88%EA%B8%B0%ED%99%94" aria-hidden="true"><span class="octicon octicon-link"></span></a>작성된 .route의 route등록객체 + flask Flask + flask_cors CORS -&gt; app객체 생성후 초기화</h5>

<ul>
  <li>clean architecture라면 <code class="language-plaintext highlighter-rouge">src&gt; main &gt; configs &gt; app.py</code>
</li>
</ul>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009214205278.png" alt="image-20221009214205278"></p>

<h4 id="003-root--runpy">
<a class="anchor" href="#003-root--runpy" aria-hidden="true"><span class="octicon octicon-link"></span></a>003 root &gt; run.py</h4>

<h5 id="app객체-import-및-name-main시-실행코드">
<a class="anchor" href="#app%EA%B0%9D%EC%B2%B4-import-%EB%B0%8F-name-main%EC%8B%9C-%EC%8B%A4%ED%96%89%EC%BD%94%EB%93%9C" aria-hidden="true"><span class="octicon octicon-link"></span></a>app객체 import 및 name main시 실행코드</h5>

<ul>
  <li>clean architecture라면 <code class="language-plaintext highlighter-rouge">root &gt; run.py</code>
</li>
</ul>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009214159517.png" alt="image-20221009214159517"></p>

<h3 id="02-clean-architecture">
<a class="anchor" href="#02-clean-architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>02 clean architecture</h3>

<h4 id="001-src-main-routes--api_routespy에-secret-get-route-추가">
<a class="anchor" href="#001-src-main-routes--api_routespy%EC%97%90-secret-get-route-%EC%B6%94%EA%B0%80" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 src&gt; main&gt; routes &gt; api_routes.py에 /secret [GET] route 추가</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>
    
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'data'</span> <span class="p">:</span> <span class="s">'Message secret'</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h3 id="03-postman으로-secret-get-route-test">
<a class="anchor" href="#03-postman%EC%9C%BC%EB%A1%9C-secret-get-route-test" aria-hidden="true"><span class="octicon octicon-link"></span></a>03 POSTMAN으로 /secret GET route TEST</h3>

<ul>
  <li>jsonify한 메세지가 잘 들어오나 확인한다.</li>
</ul>

<h2 id="2-flask-login-대신-pyjwt">
<a class="anchor" href="#2-flask-login-%EB%8C%80%EC%8B%A0-pyjwt" aria-hidden="true"><span class="octicon octicon-link"></span></a>2 Flask-login 대신 PyJWT</h2>

<h3 id="01-pyjwt-설치">
<a class="anchor" href="#01-pyjwt-%EC%84%A4%EC%B9%98" aria-hidden="true"><span class="octicon octicon-link"></span></a>01 PyJWT 설치</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install PyJWT
</code></pre></div></div>

<h3 id="02-jwt-datetime-datetimetimedelta-import-하고-auth-post-route-추가">
<a class="anchor" href="#02-jwt-datetime-datetimetimedelta-import-%ED%95%98%EA%B3%A0-auth-post-route-%EC%B6%94%EA%B0%80" aria-hidden="true"><span class="octicon octicon-link"></span></a>02 jwt, datetime-datetime/timedelta import 하고 /auth [POST] route 추가</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="c1">#...
</span>
<span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/auth'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">authorize_user</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div></div>

<h3 id="03-auth-post-route에서-token-발급---jwtencodeexp-dattime--key-algorithm로-token-생성">
<a class="anchor" href="#03-auth-post-route%EC%97%90%EC%84%9C-token-%EB%B0%9C%EA%B8%89---jwtencodeexp-dattime--key-algorithm%EB%A1%9C-token-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>03 /auth POST route에서 token 발급 -&gt; jwt.encode({‘exp’: dattime }, key=, algorithm=)로 token 생성</h3>

<h4 id="route내에서-jwt모듈은-exp만료기간을-포함한-dict를-key와-algorithm을-지정하여-encode-메서드로-token을-만든다">
<a class="anchor" href="#route%EB%82%B4%EC%97%90%EC%84%9C-jwt%EB%AA%A8%EB%93%88%EC%9D%80-exp%EB%A7%8C%EB%A3%8C%EA%B8%B0%EA%B0%84%EC%9D%84-%ED%8F%AC%ED%95%A8%ED%95%9C-dict%EB%A5%BC-key%EC%99%80-algorithm%EC%9D%84-%EC%A7%80%EC%A0%95%ED%95%98%EC%97%AC-encode-%EB%A9%94%EC%84%9C%EB%93%9C%EB%A1%9C-token%EC%9D%84-%EB%A7%8C%EB%93%A0%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>route내에서 jwt모듈은 ‘exp(만료기간)’을 포함한 dict를 key=와 algorithm=을 지정하여 .encode() 메서드로 token을 만든다.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/auth'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">authorize_user</span><span class="p">():</span>
    
    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span>
        <span class="s">'exp'</span> <span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'token'</span><span class="p">:</span> <span class="n">token</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h4 id="rs256과-hs256-둘다-sha-256암호화-알고리즘이지만-hs가-secret-key를-가지고-암호화해서-더-안전하다고-한다">
<a class="anchor" href="#rs256%EA%B3%BC-hs256-%EB%91%98%EB%8B%A4-sha-256%EC%95%94%ED%98%B8%ED%99%94-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98%EC%9D%B4%EC%A7%80%EB%A7%8C-hs%EA%B0%80-secret-key%EB%A5%BC-%EA%B0%80%EC%A7%80%EA%B3%A0-%EC%95%94%ED%98%B8%ED%99%94%ED%95%B4%EC%84%9C-%EB%8D%94-%EC%95%88%EC%A0%84%ED%95%98%EB%8B%A4%EA%B3%A0-%ED%95%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>RS256과 HS256 둘다 SHA-256암호화 알고리즘이지만, HS가 secret key를 가지고 암호화해서 더 안전하다고 한다</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009220316821.png" alt="image-20221009220316821"></p>

<h4 id="환경변수-지정해서-flask-run---postman으로-확인하기">
<a class="anchor" href="#%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EC%A7%80%EC%A0%95%ED%95%B4%EC%84%9C-flask-run---postman%EC%9C%BC%EB%A1%9C-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>환경변수 지정해서, flask run -&gt; POSTMAN으로 확인하기</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export FLASK_APP=run.py
export FLASK_ENV=development
flask run
</code></pre></div></div>

<ul>
  <li>
    <p>**POST는 headers가 필수며 **</p>

    <ul>
      <li>Content-Type: application/json</li>
    </ul>
  </li>
  <li>
    <p><strong>body는 raw로 내용물을 넣어서 보낸다.</strong></p>

    <ul>
      <li>여기선 route에서 아직 안받으므로 아무거나 보낸다
        <ul>
          <li>username:</li>
          <li>password:</li>
        </ul>
      </li>
    </ul>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009221118022.png" alt="image-20221009221118022"></p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009221200419.png" alt="image-20221009221200419"></p>
  </li>
</ul>

<h4 id="생성된-token을-버리지-말고-가지고-있는다">
<a class="anchor" href="#%EC%83%9D%EC%84%B1%EB%90%9C-token%EC%9D%84-%EB%B2%84%EB%A6%AC%EC%A7%80-%EB%A7%90%EA%B3%A0-%EA%B0%80%EC%A7%80%EA%B3%A0-%EC%9E%88%EB%8A%94%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>생성된 token을 버리지 말고 가지고 있는다.</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjUzMjI3MTl9.km9cSKTBbOLbnHnsH3zq3dEfswdP57pizIFEpyf5_xY
</code></pre></div></div>

<h2 id="3-기본token-발급-및-decode시-발생하는-예외-처리">
<a class="anchor" href="#3-%EA%B8%B0%EB%B3%B8token-%EB%B0%9C%EA%B8%89-%EB%B0%8F-decode%EC%8B%9C-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC" aria-hidden="true"><span class="octicon octicon-link"></span></a>3 기본token 발급 및 decode시 발생하는 예외 처리</h2>

<h3 id="01-token-decode-검사-in-headersgetauthorization-in-get-route">
<a class="anchor" href="#01-token-decode-%EA%B2%80%EC%82%AC-in-headersgetauthorization-in-get-route" aria-hidden="true"><span class="octicon octicon-link"></span></a>01 token decode 검사 in Headers.get(“Authorization”) in GET route</h3>

<h4 id="001-error-secret-get-route에서-requestheaders-속-authorization-key를-확인하고-token자체가-없으면-token문제가-아니라-400-bad-request다">
<a class="anchor" href="#001-error-secret-get-route%EC%97%90%EC%84%9C-requestheaders-%EC%86%8D-authorization-key%EB%A5%BC-%ED%99%95%EC%9D%B8%ED%95%98%EA%B3%A0-token%EC%9E%90%EC%B2%B4%EA%B0%80-%EC%97%86%EC%9C%BC%EB%A9%B4-token%EB%AC%B8%EC%A0%9C%EA%B0%80-%EC%95%84%EB%8B%88%EB%9D%BC-400-bad-request%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 [ERROR] /secret GET route에서 request.headers 속 “Authorization” key를 확인하고 token자체가 없으면 token문제가 아니라 400 Bad Request다</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'data'</span> <span class="p">:</span> <span class="s">'Message secret'</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h4 id="002-postman에서는-get요청시-authorization-type을-bearer--token을-선택하고-jwtencode로-만든-토큰을-입력한다">
<a class="anchor" href="#002-postman%EC%97%90%EC%84%9C%EB%8A%94-get%EC%9A%94%EC%B2%AD%EC%8B%9C-authorization-type%EC%9D%84-bearer--token%EC%9D%84-%EC%84%A0%ED%83%9D%ED%95%98%EA%B3%A0-jwtencode%EB%A1%9C-%EB%A7%8C%EB%93%A0-%ED%86%A0%ED%81%B0%EC%9D%84-%EC%9E%85%EB%A0%A5%ED%95%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 POSTMAN에서는 GET요청시 Authorization TYPE을 Bearer  Token을 선택하고, jwt.encode로 만든 토큰을 입력한다.</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjUzMjI3MTl9.km9cSKTBbOLbnHnsH3zq3dEfswdP57pizIFEpyf5_xY
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009224324071.png" alt="image-20221009224324071"></p>

<ul>
  <li>
    <p>현재 토큰의 존재검사는 통과하니 data가 잘 나온다.</p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009224642197.png" alt="image-20221009224642197"></p>
  </li>
  <li>
    <p>token을 삭제하고 send보내면 401에러가 뜨는지 확인한다.</p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009224707102.png" alt="image-20221009224707102"></p>
  </li>
</ul>

<h4 id="003-받은-token을-출력해본다">
<a class="anchor" href="#003-%EB%B0%9B%EC%9D%80-token%EC%9D%84-%EC%B6%9C%EB%A0%A5%ED%95%B4%EB%B3%B8%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>003 받은 token을 출력해본다.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">print</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'data'</span> <span class="p">:</span> <span class="s">'Message secret'</span>
    <span class="p">}),</span> <span class="mi">200</span>

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009224837323.png" alt="image-20221009224837323"></p>

<h4 id="004-token은-사실-앞에-bearer--가-붙은-raw_token으로-간주하고-split해서-token만-취한-뒤--jwtdecodekey-algorhitm으로-암호화시-사용한-동일-key와-algo로-암호화해독한-token_information을-출력해본다">
<a class="anchor" href="#004-token%EC%9D%80-%EC%82%AC%EC%8B%A4-%EC%95%9E%EC%97%90-bearer--%EA%B0%80-%EB%B6%99%EC%9D%80-raw_token%EC%9C%BC%EB%A1%9C-%EA%B0%84%EC%A3%BC%ED%95%98%EA%B3%A0-split%ED%95%B4%EC%84%9C-token%EB%A7%8C-%EC%B7%A8%ED%95%9C-%EB%92%A4--jwtdecodekey-algorhitm%EC%9C%BC%EB%A1%9C-%EC%95%94%ED%98%B8%ED%99%94%EC%8B%9C-%EC%82%AC%EC%9A%A9%ED%95%9C-%EB%8F%99%EC%9D%BC-key%EC%99%80-algo%EB%A1%9C-%EC%95%94%ED%98%B8%ED%99%94%ED%95%B4%EB%8F%85%ED%95%9C-token_information%EC%9D%84-%EC%B6%9C%EB%A0%A5%ED%95%B4%EB%B3%B8%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>004 token은 사실 앞에 <code class="language-plaintext highlighter-rouge">Bearer[ ] </code>가 붙은 raw_token으로 간주하고 split해서 token만 취한 뒤 , jwt.decode(,key=, algorhitm=)으로 암호화시 사용한 동일 key와 algo로 암호화해독한 token_information을 출력해본다.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>
    <span class="n">raw_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">print</span><span class="p">(</span><span class="n">raw_token</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">raw_token</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">token_information</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">token_information</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'data'</span> <span class="p">:</span> <span class="s">'Message secret'</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h5 id="나는-한참있다가-했더니-post-route에서-발급한-token-expire--jwtexceptionsexpiredsignatureeror가-난다">
<a class="anchor" href="#%EB%82%98%EB%8A%94-%ED%95%9C%EC%B0%B8%EC%9E%88%EB%8B%A4%EA%B0%80-%ED%96%88%EB%8D%94%EB%8B%88-post-route%EC%97%90%EC%84%9C-%EB%B0%9C%EA%B8%89%ED%95%9C-token-expire--jwtexceptionsexpiredsignatureeror%EA%B0%80-%EB%82%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>나는 한참있다가 했더니.. POST route에서 발급한 token expire =&gt; jwt.exceptions.ExpiredSignatureEror가 난다</h5>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009230510842.png" alt="image-20221009230510842"></p>

<h5 id="다시-auth-post-route에서-토큰을-발급생성하고-secret-get-route에서-토큰-검사를-해보자">
<a class="anchor" href="#%EB%8B%A4%EC%8B%9C-auth-post-route%EC%97%90%EC%84%9C-%ED%86%A0%ED%81%B0%EC%9D%84-%EB%B0%9C%EA%B8%89%EC%83%9D%EC%84%B1%ED%95%98%EA%B3%A0-secret-get-route%EC%97%90%EC%84%9C-%ED%86%A0%ED%81%B0-%EA%B2%80%EC%82%AC%EB%A5%BC-%ED%95%B4%EB%B3%B4%EC%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>다시 /auth POST route에서 토큰을 발급(생성)하고, /secret GET route에서 토큰 검사를 해보자.</h5>

<ol>
  <li>
    <p>POSTMAN에 다른 탭을 쓴 덕택에 post코드가 남아있다.</p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009230653220.png" alt="image-20221009230653220"></p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjUzMjYxOTZ9.skUZSXEso8BILbzGWFk2BVWyEMhetZGSKLnOdaEmtvg
</code></pre></div>    </div>
  </li>
  <li>
    <p>해당토큰을 다시 GET에서 사용자가 headers에 담아서 보냈다고 가정하자.</p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009230738952.png" alt="image-20221009230738952"></p>
  </li>
  <li>
    <p>잘들어오니 -&gt; <strong>decode한 token 출력을 확인해보자</strong></p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009230803647.png" alt="image-20221009230803647"></p>
  </li>
</ol>

<h5 id="decode한-token은-encode할때의-dictexp포함가-그대로-출력된다">
<a class="anchor" href="#decode%ED%95%9C-token%EC%9D%80-encode%ED%95%A0%EB%95%8C%EC%9D%98-dictexp%ED%8F%AC%ED%95%A8%EA%B0%80-%EA%B7%B8%EB%8C%80%EB%A1%9C-%EC%B6%9C%EB%A0%A5%EB%90%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>decode한 token은 encode할때의 dict(‘exp’포함)가 그대로 출력된다</h5>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009230839458.png" alt="image-20221009230839458"></p>

<h3 id="02-invalid한-token막토큰-12개-지운-토큰해서-get요청해보기">
<a class="anchor" href="#02-invalid%ED%95%9C-token%EB%A7%89%ED%86%A0%ED%81%B0-12%EA%B0%9C-%EC%A7%80%EC%9A%B4-%ED%86%A0%ED%81%B0%ED%95%B4%EC%84%9C-get%EC%9A%94%EC%B2%AD%ED%95%B4%EB%B3%B4%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>02 invalid한 token(막토큰, 1~2개 지운 토큰)해서 GET요청해보기</h3>

<h4 id="001-error-막token은-검사시-jwtexceptionsdecodeerror가-난다---근데-막토큰을-올릴이-없다">
<a class="anchor" href="#001-error-%EB%A7%89token%EC%9D%80-%EA%B2%80%EC%82%AC%EC%8B%9C-jwtexceptionsdecodeerror%EA%B0%80-%EB%82%9C%EB%8B%A4---%EA%B7%BC%EB%8D%B0-%EB%A7%89%ED%86%A0%ED%81%B0%EC%9D%84-%EC%98%AC%EB%A6%B4%EC%9D%B4-%EC%97%86%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 [ERROR] 막token은 검사시 jwt.exceptions.DecodeError가 난다 -&gt; 근데 막토큰을 올릴이 없다?</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009230941059.png" alt="image-20221009230941059"></p>

<h4 id="002-error-원래-토큰에서-12글자를-지우면-jwtexceptionsinvalidsignatureerror가-난다">
<a class="anchor" href="#002-error-%EC%9B%90%EB%9E%98-%ED%86%A0%ED%81%B0%EC%97%90%EC%84%9C-12%EA%B8%80%EC%9E%90%EB%A5%BC-%EC%A7%80%EC%9A%B0%EB%A9%B4-jwtexceptionsinvalidsignatureerror%EA%B0%80-%EB%82%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 [ERROR] 원래 토큰에서 1~2글자를 지우면, jwt.exceptions.InvalidSignatureError가 난다</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009231649576.png" alt="image-20221009231649576"></p>

<h5 id="error-막token말고-12글자빠진-tokeninvalid-token을-if-not-token과-동일한-498로-잡자">
<a class="anchor" href="#error-%EB%A7%89token%EB%A7%90%EA%B3%A0-12%EA%B8%80%EC%9E%90%EB%B9%A0%EC%A7%84-tokeninvalid-token%EC%9D%84-if-not-token%EA%B3%BC-%EB%8F%99%EC%9D%BC%ED%95%9C-498%EB%A1%9C-%EC%9E%A1%EC%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>[ERROR] 막token말고 1~2글자빠진 token(Invalid token)을 if not token과 동일한 498로 잡자</h5>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>
    <span class="n">raw_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">raw_token</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">token_information</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">InvalidSignatureError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Invalid Token"</span>
        <span class="p">}),</span> <span class="mi">498</span>

</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009232258804.png" alt="image-20221009232258804"></p>

<h3 id="03-token-발급-auth-post-route에서-발급encode시-exp를-1초로해서-expire관련-에러-잡기">
<a class="anchor" href="#03-token-%EB%B0%9C%EA%B8%89-auth-post-route%EC%97%90%EC%84%9C-%EB%B0%9C%EA%B8%89encode%EC%8B%9C-exp%EB%A5%BC-1%EC%B4%88%EB%A1%9C%ED%95%B4%EC%84%9C-expire%EA%B4%80%EB%A0%A8-%EC%97%90%EB%9F%AC-%EC%9E%A1%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>03 token 발급 /auth POST route에서 발급(encode)시 exp를 1초로해서.. Expire관련 에러 잡기</h3>

<h4 id="001-post-발급route에서-encode시-exp의-값을-현재시간--timedeltaseconds1로-줘서-무조건-만료된-상태를-만단다">
<a class="anchor" href="#001-post-%EB%B0%9C%EA%B8%89route%EC%97%90%EC%84%9C-encode%EC%8B%9C-exp%EC%9D%98-%EA%B0%92%EC%9D%84-%ED%98%84%EC%9E%AC%EC%8B%9C%EA%B0%84--timedeltaseconds1%EB%A1%9C-%EC%A4%98%EC%84%9C-%EB%AC%B4%EC%A1%B0%EA%B1%B4-%EB%A7%8C%EB%A3%8C%EB%90%9C-%EC%83%81%ED%83%9C%EB%A5%BC-%EB%A7%8C%EB%8B%A8%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 POST 발급route에서 encode시 ‘exp’의 값을 현재시간 + timedelta(seconds=1)로 줘서 무조건 만료된 상태를 만단다.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/auth'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">authorize_user</span><span class="p">():</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span>
        <span class="s">'exp'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'token'</span><span class="p">:</span> <span class="n">token</span>
    <span class="p">}),</span> <span class="mi">200</span>

</code></pre></div></div>

<h4 id="002-error-get-확인-route에서-jwtexpiredsignatureerror를-토큰이-존재하지-않을-때와-동일한-401unauthorized로-잡는다">
<a class="anchor" href="#002-error-get-%ED%99%95%EC%9D%B8-route%EC%97%90%EC%84%9C-jwtexpiredsignatureerror%EB%A5%BC-%ED%86%A0%ED%81%B0%EC%9D%B4-%EC%A1%B4%EC%9E%AC%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%84-%EB%95%8C%EC%99%80-%EB%8F%99%EC%9D%BC%ED%95%9C-401unauthorized%EB%A1%9C-%EC%9E%A1%EB%8A%94%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 [ERROR] GET 확인 route에서 jwt.ExpiredSignatureError를 토큰이 존재하지 않을 때와 동일한 401(Unauthorized)로 잡는다.</h4>

<ul>
  <li>굳이 내용물을 출력해서 확인할 필요없다
    <ul>
      <li>POST요청시 받아서 복사만 해둔다.</li>
      <li>GET에서 출력했떤 것은 headers 속 raw_token -&gt; token으로 split이 필요했기 때문에</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>
    <span class="n">raw_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">raw_token</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">token_information</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">InvalidSignatureError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Invalid Token"</span>
        <span class="p">}),</span> <span class="mi">498</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Unauthorized"</span>
        <span class="p">}),</span> <span class="mi">401</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'data'</span><span class="p">:</span> <span class="s">'Message secret'</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h4 id="003-postman에서-post-1초짜리-발급----get-expiredtoken401을-확인한다">
<a class="anchor" href="#003-postman%EC%97%90%EC%84%9C-post-1%EC%B4%88%EC%A7%9C%EB%A6%AC-%EB%B0%9C%EA%B8%89----get-expiredtoken401%EC%9D%84-%ED%99%95%EC%9D%B8%ED%95%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>003 POSTMAN에서 POST 1초짜리 발급 -&gt;  GET ExpiredToken401을 확인한다.</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009234345130.png" alt="image-20221009234345130"></p>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009234406851.png" alt="image-20221009234406851"></p>

<h4 id="expiredtoken-에럴-잡았으면-다시-exp를-30분으로-돌려놓자">
<a class="anchor" href="#expiredtoken-%EC%97%90%EB%9F%B4-%EC%9E%A1%EC%95%98%EC%9C%BC%EB%A9%B4-%EB%8B%A4%EC%8B%9C-exp%EB%A5%BC-30%EB%B6%84%EC%9C%BC%EB%A1%9C-%EB%8F%8C%EB%A0%A4%EB%86%93%EC%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>expiredtoken 에럴 잡았으면 다시 exp를 30분으로 돌려놓자</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009234718731.png" alt="image-20221009234718731"></p>

<h4 id="참고--expired-token-이외에--498-invalid-token도-401으로-잡아도-된다">
<a class="anchor" href="#%EC%B0%B8%EA%B3%A0--expired-token-%EC%9D%B4%EC%99%B8%EC%97%90--498-invalid-token%EB%8F%84-401%EC%9C%BC%EB%A1%9C-%EC%9E%A1%EC%95%84%EB%8F%84-%EB%90%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>참고)  expired token 이외에 + 498 invalid token도 401으로 잡아도 된다.</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009234821737.png" alt="image-20221009234821737"></p>

<h2 id="4-agent의-token외-user의-id-uid도-추가">
<a class="anchor" href="#4-agent%EC%9D%98-token%EC%99%B8-user%EC%9D%98-id-uid%EB%8F%84-%EC%B6%94%EA%B0%80" aria-hidden="true"><span class="octicon octicon-link"></span></a>4 Agent의 token외 user의 id (uid)도 추가</h2>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009235215344.png" alt="image-20221009235215344"></p>

<h3 id="01-token발급-route에서-exp외에-발급요청자의-uid를-포함해서-발급">
<a class="anchor" href="#01-token%EB%B0%9C%EA%B8%89-route%EC%97%90%EC%84%9C-exp%EC%99%B8%EC%97%90-%EB%B0%9C%EA%B8%89%EC%9A%94%EC%B2%AD%EC%9E%90%EC%9D%98-uid%EB%A5%BC-%ED%8F%AC%ED%95%A8%ED%95%B4%EC%84%9C-%EB%B0%9C%EA%B8%89" aria-hidden="true"><span class="octicon octicon-link"></span></a>01 token발급 route에서 exp외에 [발급요청자의 uid]를 포함해서 발급</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/auth'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">authorize_user</span><span class="p">():</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span>
        <span class="s">'exp'</span><span class="p">:</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
        <span class="s">'uid'</span><span class="p">:</span> <span class="mi">12</span>
    <span class="p">},</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'token'</span><span class="p">:</span> <span class="n">token</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h3 id="02-token확인-route에서-headers에-authorization이외에-현재user의-token확인요청자의-uid도-꺼내서-token발급자의-uid와-비교">
<a class="anchor" href="#02-token%ED%99%95%EC%9D%B8-route%EC%97%90%EC%84%9C-headers%EC%97%90-authorization%EC%9D%B4%EC%99%B8%EC%97%90-%ED%98%84%EC%9E%ACuser%EC%9D%98-token%ED%99%95%EC%9D%B8%EC%9A%94%EC%B2%AD%EC%9E%90%EC%9D%98-uid%EB%8F%84-%EA%BA%BC%EB%82%B4%EC%84%9C-token%EB%B0%9C%EA%B8%89%EC%9E%90%EC%9D%98-uid%EC%99%80-%EB%B9%84%EA%B5%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>02 token확인 route에서, headers에 “Authorization”이외에 현재user의 [token확인요청자의 “uid”]도 꺼내서 [token발급자의 uid]와 비교</h3>

<h4 id="001-error-현재-요청사용자의-uid를-headers에서-꺼낸다-token이-없는것-외에-uid가-없어도-400에러다">
<a class="anchor" href="#001-error-%ED%98%84%EC%9E%AC-%EC%9A%94%EC%B2%AD%EC%82%AC%EC%9A%A9%EC%9E%90%EC%9D%98-uid%EB%A5%BC-headers%EC%97%90%EC%84%9C-%EA%BA%BC%EB%82%B8%EB%8B%A4-token%EC%9D%B4-%EC%97%86%EB%8A%94%EA%B2%83-%EC%99%B8%EC%97%90-uid%EA%B0%80-%EC%97%86%EC%96%B4%EB%8F%84-400%EC%97%90%EB%9F%AC%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 [ERROR] 현재 요청사용자의 uid를 headers에서 꺼낸다. token이 없는것 외에 uid가 없어도 400에러다</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>

    <span class="n">raw_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"uid"</span><span class="p">)</span>

    <span class="c1"># if not raw_token:
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">uid</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>
</code></pre></div></div>

<h4 id="002-발급시-token에-포함된-uid를--decode된-token_information에서-꺼내-변수로-받아놓는다">
<a class="anchor" href="#002-%EB%B0%9C%EA%B8%89%EC%8B%9C-token%EC%97%90-%ED%8F%AC%ED%95%A8%EB%90%9C-uid%EB%A5%BC--decode%EB%90%9C-token_information%EC%97%90%EC%84%9C-%EA%BA%BC%EB%82%B4-%EB%B3%80%EC%88%98%EB%A1%9C-%EB%B0%9B%EC%95%84%EB%86%93%EB%8A%94%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 발급시 token에 포함된 uid를  decode된 token_information에서 꺼내 변수로 받아놓는다.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>

    <span class="n">raw_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"uid"</span><span class="p">)</span>

    <span class="c1"># if not raw_token:
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">uid</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">raw_token</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">token_information</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
        <span class="n">token_uid</span> <span class="o">=</span> <span class="n">token_information</span><span class="p">[</span><span class="s">"uid"</span><span class="p">]</span>
</code></pre></div></div>

<h4 id="003-token-decode과정에서-발생하는-예외통과시-token_uid-vs-현재uid를-비교하여-다를시-400으로-예외를-처리한다형변환해서-확인">
<a class="anchor" href="#003-token-decode%EA%B3%BC%EC%A0%95%EC%97%90%EC%84%9C-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EC%98%88%EC%99%B8%ED%86%B5%EA%B3%BC%EC%8B%9C-token_uid-vs-%ED%98%84%EC%9E%ACuid%EB%A5%BC-%EB%B9%84%EA%B5%90%ED%95%98%EC%97%AC-%EB%8B%A4%EB%A5%BC%EC%8B%9C-400%EC%9C%BC%EB%A1%9C-%EC%98%88%EC%99%B8%EB%A5%BC-%EC%B2%98%EB%A6%AC%ED%95%9C%EB%8B%A4%ED%98%95%EB%B3%80%ED%99%98%ED%95%B4%EC%84%9C-%ED%99%95%EC%9D%B8" aria-hidden="true"><span class="octicon octicon-link"></span></a>003 token decode과정에서 발생하는 예외통과시, token_uid vs 현재uid를 비교하여 다를시, 400으로 예외를 처리한다(형변환해서 확인)</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>

    <span class="c1">#...
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">raw_token</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">token_information</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
        <span class="n">token_uid</span> <span class="o">=</span> <span class="n">token_information</span><span class="p">[</span><span class="s">"uid"</span><span class="p">]</span>

    <span class="c1">#...
</span>    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Unauthorized"</span>
        <span class="p">}),</span> <span class="mi">401</span>

    <span class="k">print</span><span class="p">(</span><span class="n">token_uid</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">token_uid</span><span class="p">),</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"User not permissin"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
        <span class="s">'data'</span><span class="p">:</span> <span class="s">'Message secret'</span>
    <span class="p">}),</span> <span class="mi">200</span>
</code></pre></div></div>

<h4 id="token관련-테스트는-항상-post로-새로-발급---복사---get으로-인증요청하자--엥-not-uid에-걸려-401-에러가-난다">
<a class="anchor" href="#token%EA%B4%80%EB%A0%A8-%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%8A%94-%ED%95%AD%EC%83%81-post%EB%A1%9C-%EC%83%88%EB%A1%9C-%EB%B0%9C%EA%B8%89---%EB%B3%B5%EC%82%AC---get%EC%9C%BC%EB%A1%9C-%EC%9D%B8%EC%A6%9D%EC%9A%94%EC%B2%AD%ED%95%98%EC%9E%90--%EC%97%A5-not-uid%EC%97%90-%EA%B1%B8%EB%A0%A4-401-%EC%97%90%EB%9F%AC%EA%B0%80-%EB%82%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>token관련 테스트는 항상 POST로 새로 발급 -&gt; 복사 -&gt; GET으로 인증요청하자 =&gt; 엥? not uid에 걸려 401 에러가 난다</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010012011997.png" alt="image-20221010012011997"></p>

<h3 id="03-uid는-authorization과-달리-postman-get요청시-headers에-직접-줘야한다">
<a class="anchor" href="#03-uid%EB%8A%94-authorization%EA%B3%BC-%EB%8B%AC%EB%A6%AC-postman-get%EC%9A%94%EC%B2%AD%EC%8B%9C-headers%EC%97%90-%EC%A7%81%EC%A0%91-%EC%A4%98%EC%95%BC%ED%95%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>03 uid는 Authorization과 달리, POSTMAN GET요청시, Headers에 직접 줘야한다</h3>

<h4 id="001-get요청시-headers를-따로-준-적이-없었는데-uid테스트가-처음이다">
<a class="anchor" href="#001-get%EC%9A%94%EC%B2%AD%EC%8B%9C-headers%EB%A5%BC-%EB%94%B0%EB%A1%9C-%EC%A4%80-%EC%A0%81%EC%9D%B4-%EC%97%86%EC%97%88%EB%8A%94%EB%8D%B0-uid%ED%85%8C%EC%8A%A4%ED%8A%B8%EA%B0%80-%EC%B2%98%EC%9D%8C%EC%9D%B4%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 GET요청시 Headers를 따로 준 적이 없었는데 uid테스트가 처음이다</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010012140462.png" alt="image-20221010012140462"></p>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010012149063.png" alt="image-20221010012149063"></p>

<h4 id="002-확인해보니-headers-속--uid는-string으로-token속-발급시-지정해준-uid는-int타입이었다">
<a class="anchor" href="#002-%ED%99%95%EC%9D%B8%ED%95%B4%EB%B3%B4%EB%8B%88-headers-%EC%86%8D--uid%EB%8A%94-string%EC%9C%BC%EB%A1%9C-token%EC%86%8D-%EB%B0%9C%EA%B8%89%EC%8B%9C-%EC%A7%80%EC%A0%95%ED%95%B4%EC%A4%80-uid%EB%8A%94-int%ED%83%80%EC%9E%85%EC%9D%B4%EC%97%88%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 확인해보니, headers 속  uid는 string으로, token속 발급시 지정해준 uid는 int타입이었다.</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">token_uid</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">token_uid</span><span class="p">),</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
<span class="c1"># 12 &lt;class 'int'&gt; 12 &lt;class 'str'&gt;
</span></code></pre></div></div>

<h4 id="003-발급시와-다른-uid를-headers에-박아서-token확인요청-한다면--token_uid-vs-uid-비교시-내는-user-not-permission이-나와야한다">
<a class="anchor" href="#003-%EB%B0%9C%EA%B8%89%EC%8B%9C%EC%99%80-%EB%8B%A4%EB%A5%B8-uid%EB%A5%BC-headers%EC%97%90-%EB%B0%95%EC%95%84%EC%84%9C-token%ED%99%95%EC%9D%B8%EC%9A%94%EC%B2%AD-%ED%95%9C%EB%8B%A4%EB%A9%B4--token_uid-vs-uid-%EB%B9%84%EA%B5%90%EC%8B%9C-%EB%82%B4%EB%8A%94-user-not-permission%EC%9D%B4-%EB%82%98%EC%99%80%EC%95%BC%ED%95%9C%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>003 발급시와 다른 uid를 headers에 박아서 token확인요청 한다면?  token_uid vs uid 비교시 내는 User not permission이 나와야한다</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010012438559.png" alt="image-20221010012438559"></p>

<h3 id="04-또다른-uid관련-에러-처리---token생성시-필수-dictk-key인-uid를--없이-생성한-경우">
<a class="anchor" href="#04-%EB%98%90%EB%8B%A4%EB%A5%B8-uid%EA%B4%80%EB%A0%A8-%EC%97%90%EB%9F%AC-%EC%B2%98%EB%A6%AC---token%EC%83%9D%EC%84%B1%EC%8B%9C-%ED%95%84%EC%88%98-dictk-key%EC%9D%B8-uid%EB%A5%BC--%EC%97%86%EC%9D%B4-%EC%83%9D%EC%84%B1%ED%95%9C-%EA%B2%BD%EC%9A%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>04 또다른 uid관련 에러 처리 -&gt; token생성시 필수 dictk-key인 uid를,  없이 생성한 경우</h3>

<h4 id="001-headers-속-uid는-get으로-꺼내고-없으면-400에러였다">
<a class="anchor" href="#001-headers-%EC%86%8D-uid%EB%8A%94-get%EC%9C%BC%EB%A1%9C-%EA%BA%BC%EB%82%B4%EA%B3%A0-%EC%97%86%EC%9C%BC%EB%A9%B4-400%EC%97%90%EB%9F%AC%EC%98%80%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>001 headers 속 uid는 .get()으로 꺼내고 없으면 400에러였다</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010012726664.png" alt="image-20221010012726664"></p>

<h4 id="002-그러나-token은--발급post시-무조건-uid를-넣은-상태로-encoding해야하며-확인요청get시-token_infouid로-강제로-key를-꺼낸다">
<a class="anchor" href="#002-%EA%B7%B8%EB%9F%AC%EB%82%98-token%EC%9D%80--%EB%B0%9C%EA%B8%89post%EC%8B%9C-%EB%AC%B4%EC%A1%B0%EA%B1%B4-uid%EB%A5%BC-%EB%84%A3%EC%9D%80-%EC%83%81%ED%83%9C%EB%A1%9C-encoding%ED%95%B4%EC%95%BC%ED%95%98%EB%A9%B0-%ED%99%95%EC%9D%B8%EC%9A%94%EC%B2%ADget%EC%8B%9C-token_infouid%EB%A1%9C-%EA%B0%95%EC%A0%9C%EB%A1%9C-key%EB%A5%BC-%EA%BA%BC%EB%82%B8%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>002 그러나 token은  발급(POST)시 무조건 uid를 넣은 상태로 encoding해야하며, 확인요청(GET)시 token_info[“uid”]로 강제로 key를 꺼낸다.</h4>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010012831765.png" alt="image-20221010012831765"></p>

<h4 id="003-error-필수적으로-있어야할-dict-key-not-get인-uid가-token에-없으면-keyerror로-잡고-401-에러를-낸다-임의로-invalid-token2로-메세지를-잡는다">
<a class="anchor" href="#003-error-%ED%95%84%EC%88%98%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%9E%88%EC%96%B4%EC%95%BC%ED%95%A0-dict-key-not-get%EC%9D%B8-uid%EA%B0%80-token%EC%97%90-%EC%97%86%EC%9C%BC%EB%A9%B4-keyerror%EB%A1%9C-%EC%9E%A1%EA%B3%A0-401-%EC%97%90%EB%9F%AC%EB%A5%BC-%EB%82%B8%EB%8B%A4-%EC%9E%84%EC%9D%98%EB%A1%9C-invalid-token2%EB%A1%9C-%EB%A9%94%EC%84%B8%EC%A7%80%EB%A5%BC-%EC%9E%A1%EB%8A%94%EB%8B%A4" aria-hidden="true"><span class="octicon octicon-link"></span></a>003 [ERROR] 필수적으로 있어야할 dict key( not .get())인 uid가 token에 없으면 KeyError로 잡고 401 에러를 낸다. 임의로 “Invalid Token2”로 메세지를 잡는다</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">api_routes_bp</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/secret"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">secret_route</span><span class="p">():</span>

    <span class="n">raw_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">)</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"uid"</span><span class="p">)</span>

    <span class="c1"># if not raw_token:
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">uid</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Bad Request"</span>
        <span class="p">}),</span> <span class="mi">400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">raw_token</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">token_information</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'1234'</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="s">'HS256'</span><span class="p">)</span>
        <span class="n">token_uid</span> <span class="o">=</span> <span class="n">token_information</span><span class="p">[</span><span class="s">"uid"</span><span class="p">]</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">InvalidSignatureError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Invalid Token"</span>
        <span class="p">}),</span> <span class="mi">498</span>

    <span class="k">except</span> <span class="n">jwt</span><span class="p">.</span><span class="n">ExpiredSignatureError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Token expried"</span>
        <span class="p">}),</span> <span class="mi">401</span>
    <span class="k">except</span> <span class="nb">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s">"error"</span><span class="p">:</span> <span class="s">"Invalid Token2"</span>
        <span class="p">}),</span> <span class="mi">401</span>

</code></pre></div></div>

<h5 id="uid없이-토큰발급-error를-내보기-위해--post-route에서-임시로-uid-key-value를-삭제하고-테스트">
<a class="anchor" href="#uid%EC%97%86%EC%9D%B4-%ED%86%A0%ED%81%B0%EB%B0%9C%EA%B8%89-error%EB%A5%BC-%EB%82%B4%EB%B3%B4%EA%B8%B0-%EC%9C%84%ED%95%B4--post-route%EC%97%90%EC%84%9C-%EC%9E%84%EC%8B%9C%EB%A1%9C-uid-key-value%EB%A5%BC-%EC%82%AD%EC%A0%9C%ED%95%98%EA%B3%A0-%ED%85%8C%EC%8A%A4%ED%8A%B8" aria-hidden="true"><span class="octicon octicon-link"></span></a>uid없이 토큰발급 Error를 내보기 위해,  POST route에서 임시로 uid key-value를 삭제하고 테스트</h5>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010013228176.png" alt="image-20221010013228176"></p>

<ul>
  <li>
    <p>POST</p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010013246974.png" alt="image-20221010013246974"></p>
  </li>
  <li>
    <p>GET</p>

    <p>​	<img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010013310646.png" alt="image-20221010013310646"></p>
  </li>
</ul>

<h5 id="다시-발급시-uid-넣어주자">
<a class="anchor" href="#%EB%8B%A4%EC%8B%9C-%EB%B0%9C%EA%B8%89%EC%8B%9C-uid-%EB%84%A3%EC%96%B4%EC%A3%BC%EC%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>다시 발급시 uid 넣어주자</h5>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221010013340328.png" alt="image-20221010013340328"></p>

<h2 id="참고">
<a class="anchor" href="#%EC%B0%B8%EA%B3%A0" aria-hidden="true"><span class="octicon octicon-link"></span></a>참고</h2>

<ul>
  <li>
<a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Robert C. Martin (Uncle Bob)의 Clean Code Blog</a>
    <ul>
      <li><a href="https://leanpub.com/clean-architectures-in-python">PDF-free-Clean Architectures in Python</a></li>
    </ul>
  </li>
  <li><a href="https://velog.io/@jahoy/Python%EC%9C%BC%EB%A1%9C-Clean-Architecture-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0">용어 참고 블로그 1편</a></li>
  <li><a href="https://velog.io/@jahoy/Python%EC%9C%BC%EB%A1%9C-%ED%81%B4%EB%A6%B0-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B02">용어 참고 블로그 2편</a></li>
  <li>
    <p><a href="https://testdriven.io/blog/fastapi-crud/#postgres-setup">fasapi vs flask</a></p>
  </li>
  <li>jsonapi 예제문서
    <ul>
      <li>https://jsonapi.org/format/#document-top-level</li>
      <li>https://jsonapi.org/format/#crud-creating-responses</li>
    </ul>
  </li>
  <li>vscode flask 디버깅 세팅 문서
    <ul>
      <li>https://code.visualstudio.com/docs/python/debugging#_flask-debugging</li>
    </ul>
  </li>
</ul>

<h4 id="gitignore">
<a class="anchor" href="#gitignore" aria-hidden="true"><span class="octicon octicon-link"></span></a>gitignore</h4>

<ul>
  <li>
    <p>git에 commit되었던 것을 ignore하고 싶을 때</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git rm [파일명] --cached
</code></pre></div>    </div>
  </li>
  <li>
    <p>git amend</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git commit --amend --no-edit
</code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li>console 등에서 init import부터 생기는 pycache폴더</li>
  <li>venv</li>
  <li>연습용 sqlite .db파일</li>
  <li>pytest시 생기는 .pytest_cache 폴더</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**/__pycache__
venv
storage.db
.pytest_cache
</code></pre></div></div>

<h4 id="sqlalchemy패키지">
<a class="anchor" href="#sqlalchemy%ED%8C%A8%ED%82%A4%EC%A7%80" aria-hidden="true"><span class="octicon octicon-link"></span></a>sqlalchemy패키지</h4>

<ul>
  <li>일반 패키지: create_engine / 칼럼재료들</li>
  <li>.orm 패키지:
    <ul>
      <li>
        <p>relatioship: 1:M에서 1에 해당하는 table이 들고 있는 가짜칼럼</p>
      </li>
      <li>
        <p>sessionmaker: handler class 속 enter에서 engine을 묶어서 session을 반환해주는 놈</p>
      </li>
      <li>
        <p>.orm.exc 패키지</p>

        <ul>
          <li>
            <p><strong>NoResultFound</strong></p>

            <ul>
              <li>
                <p><strong>repo에서</strong> pk로 select시 .one()으로 1개만 찾을 때, 없으면 발생하는 예외</p>
              </li>
              <li>
                <p>따로 except를 잡아서 빈list를 반환(select는 원래 List반환)</p>

                <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009023057244.png" alt="image-20221009023057244"></p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>.exc 패키지(exception):</p>

    <ul>
      <li>
        <p><strong>IntegrityError</strong>:</p>

        <ul>
          <li>
            <p><strong>adapter에서 처리</strong>하며 register시 unique key 중복시 나는 에러</p>

            <ul>
              <li>
                <p>repo에서는 그냥 raise만 올려놓고, adapter에서 잡더라</p>

                <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221009014640656.png" alt="image-20221009014640656"></p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>계층별 변수정리
    <ul>
      <li>id : sqlalchemy -&gt; <strong>repo 인자부터는</strong> fk_id도 있으니 <code class="language-plaintext highlighter-rouge">pk_id</code>
</li>
      <li>
        <p>name: sqlalchemy-&gt;repo-&gt;usecase까지는 그냥 name (선택인자 개별메서드에by_name)-&gt; <strong>controller 인자부터는 외부에선 다른(pet)_name도 있으니 <code class="language-plaintext highlighter-rouge">fk_name</code></strong></p>

        <ul>
          <li><strong>OneEntity의 경우 그냥 controller에서도 <code class="language-plaintext highlighter-rouge">name</code>만</strong></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>route 조심해야할 것</strong></p>

    <ul>
      <li>
        <p>register route는 response.body에 controller response[“Data”]에 있던 <strong>DTO가 반환</strong></p>
      </li>
      <li>
        <p><strong>find route</strong>는 response.body에 controller response[“Data”]에 있던 List<strong>EntityModel객체 반환</strong>되니 <strong>message 작성시 enum필드에 대해 .value까지 해서 보내기</strong></p>
      </li>
    </ul>
  </li>
  <li>
    <p>repo 조심해야할 것</p>

    <ul>
      <li>
<strong>select repo</strong>는
        <ul>
          <li>fk에 대해서는 항상 <strong>.all()로 조회</strong>해서 <strong>없어도 빈list반환하며 에러안남</strong>
</li>
          <li><strong>pk or unique key에 대해서는 <code class="language-plaintext highlighter-rouge">.one()</code>으로 조회하므로 <code class="language-plaintext highlighter-rouge">없을 때는 NoResultFound</code>가 나니 예외처리 필수</strong></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="github에서-br따서-작업하기">
<a class="anchor" href="#github%EC%97%90%EC%84%9C-br%EB%94%B0%EC%84%9C-%EC%9E%91%EC%97%85%ED%95%98%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>github에서 br따서 작업하기</h4>

<h5 id="1-1-github에서-br생성--clone">
<a class="anchor" href="#1-1-github%EC%97%90%EC%84%9C-br%EC%83%9D%EC%84%B1--clone" aria-hidden="true"><span class="octicon octicon-link"></span></a>[1-1] github에서 br생성 ~ clone</h5>

<ol>
  <li>
    <p>github에 들어가서 <code class="language-plaintext highlighter-rouge">feat/~</code>로 브랜치 생성</p>
  </li>
  <li>
    <p>해당 br만 clone</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git clone -b [branch] [git주소]
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="clone후-초기-작업-세팅">
<a class="anchor" href="#clone%ED%9B%84-%EC%B4%88%EA%B8%B0-%EC%9E%91%EC%97%85-%EC%84%B8%ED%8C%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>clone후 초기 작업 세팅</h5>

<ol>
  <li>gitignore중에 db파일 있으면 옮겨주기
    <ul>
      <li>없으면 config import해서 Base + handler -&gt; get_enigne -&gt; bind한 다음, create_all()해줘야할듯??</li>
    </ul>
  </li>
</ol>

<p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20220929154256052.png" alt="image-20220929154256052"></p>

<ol>
  <li>github에서 따온 빈 새br에 대해, venv를 만들고 활성화하고  vscode를 연다</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python -m virtualenv -p python310 venv

.\venv\Scripts\activate
</code></pre></div></div>

<ol>
  <li>최초 requirements.txt 직접 설치</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip3 install -r requirements.txt
</code></pre></div></div>

<ol>
  <li>최초 pre-commit install 직접 세팅</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pre-commit install
</code></pre></div></div>

<ol>
  <li>vscode 열고 interpreter venv로 지정</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>code .
</code></pre></div></div>

<h5 id="1-2-작업끝난-br의-폴더에서-새-작업-br생성--분기게시-초기세팅-또-안해도-되는-장점">
<a class="anchor" href="#1-2-%EC%9E%91%EC%97%85%EB%81%9D%EB%82%9C-br%EC%9D%98-%ED%8F%B4%EB%8D%94%EC%97%90%EC%84%9C-%EC%83%88-%EC%9E%91%EC%97%85-br%EC%83%9D%EC%84%B1--%EB%B6%84%EA%B8%B0%EA%B2%8C%EC%8B%9C-%EC%B4%88%EA%B8%B0%EC%84%B8%ED%8C%85-%EB%98%90-%EC%95%88%ED%95%B4%EB%8F%84-%EB%90%98%EB%8A%94-%EC%9E%A5%EC%A0%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>[1-2] 작업끝난 br의 폴더에서 새 작업 br생성 ~ 분기게시 (초기세팅 또 안해도 되는 장점)</h5>

<ol>
  <li>
    <p>현재 br를 확인한다.</p>

    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">git</span> <span class="n">branch</span>
<span class="o">*</span> <span class="n">feat</span><span class="o">/</span><span class="n">register_user_use_case</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>checkout -b</strong>로 새 br 생성하여 진입하기</p>

    <ul>
      <li>원래는 github에서 create branch했었음.</li>
    </ul>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git checkout -b feat/generic_use_cases
   
git branch
   
* feat/generic_use_cases
  feat/register_user_use_case
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>git push -u origin [branch명]으로 <code class="language-plaintext highlighter-rouge">새로생성한 br를 push해서 github에 생성하기</code></strong></p>

    <ul>
      <li>vscode에서는 push -u origin [branch] 대신  <strong><code class="language-plaintext highlighter-rouge">분기게시</code>가 뜬다.</strong>
</li>
    </ul>
  </li>
  <li>
    <p>github에서 <strong>빈 분기가 생성되었는지 확인하기</strong></p>

    <ul>
      <li>github에 merge되기 위해서는 <strong>직전 작업이후 <code class="language-plaintext highlighter-rouge">github에 새 작업 br를 먼저 생성해놓고 작업</code>에 들어가야한다</strong>
</li>
    </ul>
  </li>
</ol>

<h5 id="1-3--옛날에-따둔-br에서-작업시작할-땐-최신-master를-pull---rebase후에-작업시작하기">
<a class="anchor" href="#1-3--%EC%98%9B%EB%82%A0%EC%97%90-%EB%94%B0%EB%91%94-br%EC%97%90%EC%84%9C-%EC%9E%91%EC%97%85%EC%8B%9C%EC%9E%91%ED%95%A0-%EB%95%90-%EC%B5%9C%EC%8B%A0-master%EB%A5%BC-pull---rebase%ED%9B%84%EC%97%90-%EC%9E%91%EC%97%85%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>[1-3]  옛날에 따둔 br에서 작업시작할 땐, 최신 master를 pull -&gt; rebase후에 작업시작하기</h5>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">git checkout master</code>를 통해 <strong>안가져와서 안보이던 master</strong>를 만든다</p>

    <ul>
      <li>
<strong>-b의 새로만든 것이 아니므로</strong> remote와 연결된 master가 된다.</li>
      <li>
<code class="language-plaintext highlighter-rouge">git branch</code>로 확인</li>
    </ul>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git checkout master
   
git branch
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">git pull</code>로 master에 최신 코드를 가져온다</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git pull
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>rebase받을 업뎃안된 작업br로 넘어간 뒤, <code class="language-plaintext highlighter-rouge">matser의 내용을 rebase로 받아온다</code></strong></p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git checkout [작업br]
   
git rebase master
   
git log --oneline
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="2-framework-있다면-venv에-환경변수-세팅---vscode-디버깅-세팅">
<a class="anchor" href="#2-framework-%EC%9E%88%EB%8B%A4%EB%A9%B4-venv%EC%97%90-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EC%84%B8%ED%8C%85---vscode-%EB%94%94%EB%B2%84%EA%B9%85-%EC%84%B8%ED%8C%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>[2] framework 있다면 venv에 환경변수 세팅 -&gt; vscode 디버깅 세팅</h5>

<ol>
  <li>
    <p>등록:</p>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">FLASK_APP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"초기화된 app객체를 import한 python파일명"</span><span class="w">
</span><span class="c">#export FLASK_APP=파일명</span><span class="w">
</span></code></pre></div>    </div>

    <ul>
      <li>powershell은 파일명은 “ “ 확장자를 뺀 쌍따옴표로</li>
      <li><strong>보통 app객체 import한 python파일은 <code class="language-plaintext highlighter-rouge">run</code>이라고 명명하며, main으로 app.run도 가지고 있다.</strong></li>
    </ul>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">FLASK_RUN_PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8000</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>확인</p>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong>cli로 framework실행</strong></p>
  </li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   flask run
</code></pre></div></div>

<ol>
  <li>
    <p><strong>vscode에 F5로 실행 및 디버깅 가능하게 세팅(.vscode/launch.json)</strong></p>

    <ol>
      <li>
        <p>vscode 좌측에 <code class="language-plaintext highlighter-rouge">실행 및 디버그</code>버튼을 클릭한다.</p>
      </li>
      <li>
        <p><strong>launch.json file</strong>을 누르고 -&gt; python -&gt; python file을 선택해서 <strong>local에 <code class="language-plaintext highlighter-rouge">.vscode &gt; launch.json</code>을 생성한다</strong></p>
      </li>
      <li>
        <p>vscode 문서 &gt; python &gt; debugging &gt; <a href="https://code.visualstudio.com/docs/python/debugging#_flask-debugging">flask debugging</a>을 찾아가서 설정을 복사해온다</p>

        <div class="language-json highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Python: Flask (development mode)"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"python"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"launch"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"module"</span><span class="p">:</span><span class="w"> </span><span class="s2">"flask"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"FLASK_APP"</span><span class="p">:</span><span class="w"> </span><span class="s2">"app.py"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"FLASK_ENV"</span><span class="p">:</span><span class="w"> </span><span class="s2">"development"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"run"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"jinja"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
      
</span></code></pre></div>        </div>
      </li>
      <li>
        <p><strong>launch.json 내용 중 <code class="language-plaintext highlighter-rouge">configurations</code> 내부 list value 중 1개로 dict를 복붙한다.</strong></p>
      </li>
      <li>
        <p><strong>FLASK_APP에 파일명이 아닌 py확장자까지 다 적어줘야한다. app객체를 import하고 있는 <code class="language-plaintext highlighter-rouge">run.py</code>를 명시해주자</strong></p>
      </li>
      <li>
        <p>다시한번 run and debug 탭을 누르고 실행시킨다.</p>
      </li>
    </ol>
  </li>
</ol>

<ul>
  <li>F5 실행, shift+F5 종료, ctrl + shilft + F5 재실행</li>
</ul>

<ol>
  <li>
    <p>F9로 route의 return부분을 break point를 찍고 -&gt; F5로 실행상태에서 -&gt; POSTMAN으로 입력을 준 뒤 -&gt;break point확인 후 확인이 끝나면 -&gt; continue(F5) 해보자.</p>
  </li>
  <li>
    <p>git commit</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>   improve: enabling debugger
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="3-해당br-작업테스트-완료후--merge까지-정리">
<a class="anchor" href="#3-%ED%95%B4%EB%8B%B9br-%EC%9E%91%EC%97%85%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%99%84%EB%A3%8C%ED%9B%84--merge%EA%B9%8C%EC%A7%80-%EC%A0%95%EB%A6%AC" aria-hidden="true"><span class="octicon octicon-link"></span></a>[3] 해당br 작업(테스트) 완료후 ~ merge까지 정리</h5>

<ol>
  <li>
    <p>status 확인후 add . 후  -am으로 커밋-&gt;실패-&gt;-am커밋</p>

    <ul>
      <li><strong>add를 먼저 날려야 add된상태로 pytest하는 것 같다?!</strong></li>
    </ul>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>git status
   
git add .
   
git commit -am "feat: implementing data interfaces"
   
git commit -am "feat: implementing data interfaces"
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>git push는 현재 로그인된 vscode에서 하고 있음.</strong></p>
  </li>
  <li>
    <p><strong>github에 들어가보면, <code class="language-plaintext highlighter-rouge">Compare &amp; pull request</code>가 떠있더라도 <code class="language-plaintext highlighter-rouge">PR탭 &gt; new PR</code>로 들어가는 버릇을 들여보자.</strong></p>
  </li>
</ol>

<ul>
  <li>Comparing change까지 들어가서 코드를 확인하고 <code class="language-plaintext highlighter-rouge">Able to merge</code> 및 <code class="language-plaintext highlighter-rouge">세부코드</code>를 확인하고 <strong>직접 Create PR까지 가자</strong>
</li>
</ul>

<ol>
  <li><strong>merge후 master에 반영되었는지까지 확인하자</strong></li>
</ol>

<h4 id="vscode-설정">
<a class="anchor" href="#vscode-%EC%84%A4%EC%A0%95" aria-hidden="true"><span class="octicon octicon-link"></span></a>vscode 설정</h4>

<ul>
  <li>캐쉬파일 안보이기</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"files.exclude"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"**/__pycache__"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"**/.pytest_cache"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<ul>
  <li>
    <p>tab시 space로 입력되기</p>

    <p><img src="https://raw.githubusercontent.com/is3js/screenshots/main/image-20221001015405760.png" alt="image-20221001015405760"></p>
  </li>
  <li>
    <p>탐색기 열기 단축키 : <code class="language-plaintext highlighter-rouge">shift + alt + R</code></p>

    <ul>
      <li>파일: 파일 탐색기에 표시</li>
    </ul>
  </li>
</ul>

<h4 id="test정리">
<a class="anchor" href="#test%EC%A0%95%EB%A6%AC" aria-hidden="true"><span class="octicon octicon-link"></span></a>test정리</h4>

<ol>
  <li>
    <p>repo_insert_X</p>

    <ol>
      <li>id제외 faker + insert메서드 -&gt; new_dto</li>
      <li>new_dto속 배정id + engine db select -&gt; query_data -&gt; engine db delete</li>
      <li>assert new_dto.필드 == query_data필드 비교</li>
    </ol>
  </li>
  <li>
    <p>repo_select_X</p>
    <ol>
      <li>id포함 faker -&gt; entity모델 객체</li>
      <li>id포함 재료들 + engine db insert -&gt; db데이터만들어놓기</li>
      <li>id, fk재료들 + select메서드 -&gt; List[entity모델객체들]</li>
      <li>engine db delete</li>
    </ol>
  </li>
</ol>

<h4 id="status_code">
<a class="anchor" href="#status_code" aria-hidden="true"><span class="octicon octicon-link"></span></a>status_code</h4>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">422</code>: validate_entry실패하는 query 속 param들 -&gt; usecase메서드의 결과물 response의 [“Success”]가 False</p>

    <ul>
      <li>
        <p><strong><code class="language-plaintext highlighter-rouge">필수param</code>(dict속 필드)이 빠졌을 경우(존재검증) or 필수param이 <code class="language-plaintext highlighter-rouge">validate_entry실패</code>할 경우 -&gt; <code class="language-plaintext highlighter-rouge">response("Success"/"Data")의 "Success"가 False</code></strong></p>

        <ul>
          <li>
            <p>use_case_controller</p>

            <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">reponse</span><span class="p">[</span><span class="s">"Success"</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">400</code>: query속 param들이 필요한 controller인데 http_request안에 아예 존재도 안했다면, 400 Bad Request에러 + 필수param(id)의 형변환 실패시</p>

    <ul>
      <li>
        <p><strong>GET요청에 대해 http_request에 필수param을 포함한 .query or .body가 아예 날라오지도 않았을 경우</strong></p>

        <ul>
          <li>
            <p>use_case_controller</p>

            <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">http_request</span><span class="p">.</span><span class="n">query</span><span class="p">:</span>
	<span class="c1"># if query
# if not query
</span><span class="k">else</span><span class="p">:</span>
</code></pre></div>            </div>

            <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">http_request</span><span class="p">.</span><span class="n">body</span><span class="p">:</span>
	<span class="c1"># if body
# if not body
</span><span class="k">else</span><span class="p">:</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>
        <p><strong>GET요청(request.args.to_dict())에 대해 필수param(id)의 형변환을 실패했을 때</strong></p>

        <ul>
          <li>
            <p>flask_adapter</p>

            <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">query_string_params</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">to_dict</span><span class="p">()</span>
       
    <span class="k">if</span> <span class="s">"pet_id"</span> <span class="ow">in</span> <span class="n">query_string_params</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">query_string_params</span><span class="p">[</span><span class="s">"pet_id"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_string_params</span><span class="p">[</span><span class="s">"pet_id"</span><span class="p">])</span>
       
    <span class="k">if</span> <span class="s">"user_id"</span> <span class="ow">in</span> <span class="n">query_string_params</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">query_string_params</span><span class="p">[</span><span class="s">"user_id"</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">query_string_params</span><span class="p">[</span><span class="s">"user_id"</span><span class="p">])</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">http_error</span> <span class="o">=</span> <span class="n">HttpErrors</span><span class="p">.</span><span class="n">error_400</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">http_error</span><span class="p">[</span><span class="s">"status_code"</span><span class="p">],</span> <span class="n">body</span><span class="o">=</span><span class="n">http_error</span><span class="p">[</span><span class="s">"body"</span><span class="p">]</span>
    <span class="p">)</span>
       
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">409</code>:  타겟 자원에 상태에 요청이 conflict를 유발한 경우</p>

    <ul>
      <li>
        <p><strong>register(insert) POST 요청에 대해 unique key(name)이 중복된 send가 날아와, db에서 unique constraint == 중복에러(IntegrityError)를 발생한 경우</strong></p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>POSTMAND에서 생성요청을 같은name를 가진 body로 2번 요청했을 때
</code></pre></div>        </div>

        <ul>
          <li>
            <p>flask_adapter</p>

            <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">api_route</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="n">http_request</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
        <span class="n">http_error</span> <span class="o">=</span> <span class="n">HttpErrors</span><span class="p">.</span><span class="n">error_409</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">http_error</span><span class="p">[</span><span class="s">"status_code"</span><span class="p">],</span> <span class="n">body</span><span class="o">=</span><span class="n">http_error</span><span class="p">[</span><span class="s">"body"</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h4 id="powershell-환경변수-등록확인">
<a class="anchor" href="#powershell-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98-%EB%93%B1%EB%A1%9D%ED%99%95%EC%9D%B8" aria-hidden="true"><span class="octicon octicon-link"></span></a>powershell 환경변수 등록/확인</h4>

<ul>
  <li>python가상환경 venv에서 activated한 상태로 적용
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">venv\Scripts\activate.ps1</code>에 저장된다.</li>
    </ul>
  </li>
</ul>

<ol>
  <li>
    <p>등록:</p>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">FLASK_APP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"hello"</span><span class="w">
</span></code></pre></div>    </div>

    <ul>
      <li>파일명은 “ “ 확장자를 뺀 쌍따옴표로</li>
    </ul>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">FLASK_RUN_PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8000</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>확인</p>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Format-Table</span><span class="w"> </span><span class="nt">-Wrap</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-powershell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">## 'LOGONSERVER' 환경변수를 찾고 싶다면,</span><span class="w">
</span><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:LOGONSERVER</span><span class="w">
   
</span><span class="c">## 'on'이 포함된 단어, ex) logONserver, ONedrive...</span><span class="w">
</span><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:</span><span class="o">*</span><span class="nx">on</span><span class="o">*</span><span class="w">
   
</span><span class="c">## 'on'으로 시작하는 단어, ONedrive ...</span><span class="w">
</span><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:on</span><span class="o">*</span><span class="w">
   
</span><span class="c">## 'on'으로 끝나는 단어, ex) processor_revisiON ...</span><span class="w">
</span><span class="nf">Get-ChildItem</span><span class="w"> </span><span class="nx">Env:</span><span class="o">*</span><span class="nx">on</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ol>


  </div><a class="u-url" href="/python/flask/cleanarchitecture/2022/09/11/%ED%81%B4%EB%A6%B0%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90_11_jwt_auth_1_%EA%B8%B0%EB%B3%B8_token%EB%B0%9C%ED%96%89%EB%B0%8F%EA%B2%80%EC%82%AC%ED%9B%84_uid%ED%99%95%EC%9D%B8%EB%B0%8F%EA%B2%80%EC%82%AC.html" hidden></a>
</article>


<!-- <script src="https://utteranc.es/client.js"
        repo="is2js/blog_raw"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script> -->
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="blog.chojaeseong.com/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>평범한 한의사 돌범의 엔지니어 도전기</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a href="/feed.xml" target="_blank" title="rss">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/is2js/" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/yarotheslav" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/yshmarov/" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
